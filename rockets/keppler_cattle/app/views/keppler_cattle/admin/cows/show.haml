.container
  .row
    .col-lg-6
      = link_to admin_cattle_cows_path, 'data-position': 'bottom', 'data-tooltip': t('keppler.actions.back') do
        .arrow-back.btn.btn-default
          %i.icon-arrow-left
          = t('keppler.actions.back')
    .col-lg-6
      .pull-right
        = link_to new_admin_cattle_cow_status_path(@cow), 'data-position': 'bottom', 'data-tooltip': 'Update status' do
          .update-status.btn.btn-primary
            %i.icon-pencil
            = t('keppler.actions.update')
            = t('keppler.models.singularize.status')

  .row
    // Cattle
    .col-md-4.col-sm-12
      .box.slice-box
        .box-header.with-border
          %h3.box-title= t('keppler.models.singularize.cow').humanize
          .box-tools.pull-right
            - if can?(model).update?
              = link_to edit_admin_cattle_cow_path(@cow), class: 'btn btn-box-tool', title: t('keppler.actions.edit') do
                %i.icon-pencil
            - if can?(model).destroy?
              = link_to admin_cattle_cow_path(@cow), class: 'btn btn-box-tool', title: t('keppler.actions.delete'), method: :delete, data: { confirm: t('keppler.messages.data_confirm') } do
                %i.icon-trash
        .box-body.no-padding
          %table.table
            %tbody
              %tr.list-row
                %th.display-label= t("activerecord.attributes.image").humanize
                %td.display-value.fs-body-1.tc-black-2
                  %center
                    = image_tag @cow.image&.url || '/assets/keppler_cattle/cow_shadow', style: 'max-width: 100%;'
                    %h5= "SIN FOTO" if @cow.image&.url.blank?
              - @cow.as_json(except: %w[id image position deleted_at]).each do |attribute, value|
                %tr.list-row
                  %th.display-label= t("activerecord.attributes.#{attribute}").humanize
                  %td.display-value.fs-body-1.tc-black-2
                    - if @attachments.dig('images', 'names').include?(attribute)
                      = image_tag value.url if value.url
                    - elsif @attachments.dig('images', 'names').map(&:pluralize).include?(attribute)
                      - value.each do |image|
                        = image_tag image.url if image.url
                    - elsif attribute.eql?('species') || attribute.eql?('gender')
                      %img.svg-icon{ src: "/assets/keppler_cattle/#{value}" }
                      = t("keppler_cattle.#{value}")
                    - elsif ['mother_id', 'father_id'].include?(attribute) && value
                      = link_to admin_cattle_cow_path(value) do
                        = cow_parent_id(value).serie_number
                    - else 
                      = sanitize raw value
    // Current Status
    .col-md-4.col-sm-12
      .box.slice-box
        .box-header.with-border
          %h3.box-title= t('keppler.models.singularize.status').humanize
        .box-body.no-padding
          %table.table
            %tbody
              - @cow.status&.as_json(except: %w[id cow_id position deleted_at]).each do |attribute, value|
                - unless value.nil?
                  %tr.list-row
                    %th.display-label= t("activerecord.attributes.#{attribute}").humanize
                    %td.display-value.fs-body-1.tc-black-2
                      - if @attachments.dig('images', 'names').include?(attribute)
                        = image_tag value.url if value.url
                      - elsif @attachments.dig('images', 'names').map(&:pluralize).include?(attribute)
                        - value.each do |image|
                          = image_tag image.url if image.url
                      - elsif value.is_a?(TrueClass) || value.is_a?(FalseClass)
                        = value ? 'Sí' : 'No'
                      - elsif attribute.include?('_id')
                        = object_name(@cow.status attribute) #|| model_name('keppler_cattle', attribute, value)
                      - else 
                        = sanitize raw value
    // Statuses
    .col-md-4.col-sm-12
      .box.slice-box
        .box-header.with-border
          %h3.box-title= @cow.statuses.empty? ? t('keppler.messages.no_events') : t("keppler.titles.history")
        .box-body.no-padding
          %ul.timeline
            - @statuses.each_with_index.each do |status, index|
              %li
                %a.timeline-item{ onclick: "statusPreview(#{status.id})", style: 'display: inline-block' }
                  %h6.timeline-header.no-border
                    %small
                      %b= status.user&.name
                      = t('keppler.messages.has')
                      - if status.eql?(@cow.statuses.first)
                        = t("keppler.actions.created").downcase
                        = t('keppler.messages.series')
                        = @cow.serie_number
                      - else
                        = t("keppler.actions.updated").downcase
                        = t("keppler.models.singularize.status").humanize
                  %span.time
                    %i.icon-clock
                    = t('keppler.messages.at')
                    = status.created_at.to_formatted_s(:time)
                    = t('keppler.messages.to')
                    = status.created_at.to_formatted_s(:day)
:scss
  .svg-icon {
    height: 30px;
    margin-right: 5px;
  }

:javascript
  window.I18n = #{current_translations.to_json.html_safe}

  String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  }

  function translateDate(date) {
    var event = new Date(date)
    // var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    let options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
    return event.toLocaleString('es-ES', options)
  }

  function formatKey(json, key) {
    if (typeof(json[key]) == 'boolean') {
      return json[key] == true ? 'Sí' : 'No'
    } else if (key == 'weight') {
      return `${json[key]} KG`
    } else if (moment(json[key], "YYYY-MM-DDTHH:mm:ss", true).isValid() || moment(json[key], "YYYY-MM-DD", true).isValid()) {
      return moment(json[key])
    } else {
      return json[key]
    }
  }

  function statusList(json) {
    var $statusList = []
    // console.log(json)
    for (var key in json) {
      // Controlando que json realmente tenga esa propiedad
      if (json.hasOwnProperty(key)) {
        // Mostrando en pantalla la clave junto a su valor
        if (#{@cow.gender?('male')}) {
          if (!['id', 'cow_id', 'pregnant', 'lactating', 'deleted_at', 'updated_at', 'position'].includes(key)) {
            $statusList.push(
              '<tr class="list-row">' +
                '<th class="display-label">' + (I18n.activerecord.attributes[key] || key).capitalize() + '</th>' +
                '<td class="display-value fs-body-1 tc-black-2" style="display: flex">' +
                  formatKey(json, key) +
                '</td>' +
              '</tr>'
            )
          } 
        } else {
          if (!['id', 'cow_id', 'reproductive', 'defiant', 'deleted_at', 'updated_at', 'position'].includes(key)) {
            $statusList.push(
              '<tr class="list-row">' +
                '<th class="display-label">' + (I18n.activerecord.attributes[key] || key).capitalize() + '</th>' +
                '<td class="display-value fs-body-1 tc-black-2" style="display: flex">' +
                  formatKey(json, key) +
                '</td>' +
              '</tr>'
            )
          }
        }
      }
    }
    // console.log($statusList)
    return $statusList.join(' ')
  }

  function statusPreview(status_id) {
    $.ajax(
        {
          type: "get",
          url: `/admin/cattle/cows/#{@cow.id}/statuses/${status_id}.json`,
          success: function(data){
          }
        }
      )
    .done(function(data) {
      // console.log(data)
      Swal({
        title: '#{t("keppler.models.singularize.status").humanize}',
        // type: 'info',
        html:
          `<div class="box slice-box">
            <div class="box-body no-padding">
              <table class="table">
                <tbody>` + 
                  statusList(data)
                + `</tbody>
              </table>
            </div>
          </div>`
      })
    })
    .error(function(data) {
      swal("Oops", "We couldn't connect to the server!", "error");
    });
  }

-# 
  function statusPreview(status_id) {
    Swal({
      preConfirm: (login) => {
        return fetch(`/admin/cattle/cows/#{@cow.id}/statuses/${status_id}.json`)
          .then(response => {
            if (!response.ok) {
              throw new Error(response.statusText)
            }
            return response.json()
          })
          .catch(error => {
            Swal.showValidationMessage(
              `Request failed: ${error}`
            )
          })
      },
      allowOutsideClick: () => !Swal.isLoading()
    })
  }
